<div x-data="alpineOperations()">
    <div>
        <div>
            <h2>Operations</h2>
            <p>
                Start a new operation or review previous ones here.
            </p>
        </div>
        <hr>
        <div class="columns">
            <div class="column">
                <h3>View</h3>
                <form>
                    <div class="field">
                        <label class="label">Choose an operation:</label>
                        <div class="control">
                            <div class="select">
                                <select id="operation-select" x-on:change="loadPlanner()" x-model="selectedOperation">
<!--                                    TODO deprecate disabled and make errors-->
                                    <option value="" disabled selected>Select an existing operation</option>
                                    {% for op in operations %}
                                        {% if op.start|length%}
                                        <!--                                TODO: check that this works-->
                                            <option id="{{ op.id|e }}-{{ op.name|e }}" value="{{ op.id|e }}">{{ op.name|e }} - {{ op.start|e }}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                <input id="agent-output" type="checkbox" x-model="isAgentOutputSelected">
                                <label for="agent-output">include agent output</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="column is-flex is-flex-direction-column is-align-items-flex-end space">
                <div class="py-1">
                    <button class="button is-primary" x-on:click="showAddModal = true">+ Add operation
                    </button>
                </div>
                <div class="py-1">
                    <button class="button is-primary">v Download full report</button>
                </div>
                <div class="py-1">
                    <button class="button is-primary">v Download event logs</button>
                </div>
                <div class="py-1">
                    <button class="button is-primary">! Delete</button>
                </div>
            </div>
        </div>
    </div>

    <template x-if="showAddModal">
        <div class="modal is-active">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Add Operation</p>
                </header>
                <section class="modal-card-body">
                    <form>
                        <label for="op-name">Operation name</label>
                        <input id="op-name" type="text" x-effect="editOperationField('name', $el, 'input')">
                        <template x-for="item in newOperation">
                            <p x-text="item"></p>
                        </template>
                        <div>
                            <h3>Basic options</h3>
                            <form>
                                <select x-effect="editOperationField('group', $el)">
                                    <option value="" selected>Use all groups</option>
                                    {% for g in groups %}
                                    <option value="{{ g|e }}">{{ g|e }}</option>
                                    {% endfor %}
                                </select>
                                <select x-effect="editOperationField('adversary', $el)">
                                    <option value="" selected>No adversary (manual)</option>
                                    {% for adv in adversaries %}
                                    {% if adv.has_repeatable_abilities %}
                                    <!--                                            TODO deprecate data-has-repeatable later, since it seems to be used for purely styling-->
                                    <option id="qflow-{{ adv.adversary_id|e }}" value="{{ adv.adversary_id|e }}"
                                            data-has-repeatable>{{ adv.name|e }}
                                    </option>
                                    {% else %}
                                    <option id="qflow-{{ adv.adversary_id|e }}" value="{{ adv.adversary_id|e }}">{{
                                        adv.name|e }}
                                    </option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                                <select x-effect="editOperationField('autoClose', $el)">
                                    <option value="0" selected>Keep open forever</option>
                                    <option value="1">Auto close operation</option>
                                </select>
                                <select x-effect="editOperationField('run', $el)">
                                    <option value="running">Run immediately</option>
                                    <option value="paused">Pause on start</option>
                                </select>
                            </form>
                        </div>
                        <div>
                            <h3>Autonomous</h3>
                            <form>
                                <select x-effect="editOperationField('autonomous', $el)">
                                    <option value="1" selected>Run autonomously</option>
                                    <option value="0">Require manual approval</option>
                                </select>
                                <select x-effect="editOperationField('planner', $el)">
                                    {% for p in planners %}
                                    {% if p.name == "atomic" %}
                                    <option value="{{ p.name|e }}" selected>Use {{ p.name|e }} planner</option>
                                    {% elif p.allow_repeatable_abilities %}
                                    <!--                                    TODO deprecate data-allow-repeatable-abilities?-->
                                    <option value="{{ p.name|e }}" data-allow-repeatable-abilities>Use {{ p.name|e }} planner</option>
                                    {% else %}
                                    <option value="{{ p.name|e }}">Use {{ p.name|e }} planner</option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                                <select x-effect="editOperationField('source', $el)">
                                    {% for s in sources %}
                                    <option value="{{ s.name|e }}">Use {{ s.name|e }} facts</option>
                                    {% endfor %}
                                </select>
                                <select x-effect="editOperationField('parsers', $el)">
                                    <option value="1" selected>Use default parsers</option>
                                    <option value="0">Do not use default parsers</option>
                                </select>
                                <label for="queueTimeout">Cleanup Timeout (secs)</label>
                                <input x-effect="editOperationField('timeout', $el, 'input')" id="queueTimeout" type="number" value="30" min="0" max="300"
                                       onchange="stream('The number of seconds Caldera will wait per cleanup action to complete before continuing.')">
                            </form>
                        </div>
                        <div>
                            <h3>Stealth</h3>
                            <form>
                                <select x-effect="editOperationField('obfuscator', $el)">
                                    {% for o in obfuscators %}
                                        <option value="{{ o.name|e }}">{{ o.name|e }} obfuscation</option>
                                    {% endfor %}
                                </select>
                                <label for="queueJitter">Jitter (min/max) sec</label>
                                <input x-effect="editOperationField('jitter', $el, 'input')" id="queueJitter"/>
                                <label for="queueVisibility">Adjust visibility: </label>
                                <input x-effect="editOperationField('visibility', $el, 'input')" id="queueVisibility" type="range" value="50" min="1" max="100" onchange="stream('The higher the visibility number, the more risk you will take with your operation getting noticed by the defense.')">
                            </form>
                        </div>
                        <div>
                            <h3>Schedule</h3>
                            <form>
                                <label for="schedule-time">Schedule operation</label>
                                <input x-effect="editOperationField('schedule', $el, 'input')" type="time" id="schedule-time">
                                <button onclick="handleScheduleAction()">
                                    Schedule
                                </button>
                            </form>
                        </div>
                    </form>
                </section>
                <footer class="modal-card-foot">
                    <!--                    TODO when user clicks on add operation it should show on view screen-->
                    <button class="button is-primary is-small" x-on:click="addOperation">Add Operation</button>
                    <button class="button is-small" x-on:click="showAddModal = false">Cancel</button>
                </footer>
            </div>
        </div>
    </template>
</div>

<script>
    function alpineOperations() {
        return {
            selectedOperation: null,
            isAgentOutputSelected: false,
            showAddModal: false,
            newOperation: {
                name: '',
                group: '',
                adversary: '',
                autoClose: '',
                // is running default?
                run: '',
                autonomous: '',
                planner: '',
                source: '',
                parsers: '',
                timeout: '',
                obfuscator: '',
                jitter: '',
                visibility: '',
                schedule: '',
            },

            editOperationField(fieldName, el, type = 'option[selected]') {

              if (this.newOperation[fieldName] !== null) {
                  if (type === 'input') {
                      this.newOperation[fieldName] = el.value;
                  }
                  else if (el.querySelector(type)) {
                      this.newOperation[fieldName] = el.querySelector(type).value;
                  }
              }
            },

            addOperation() {
                console.log('ADD OPERATION', this.newOperation);
            }
        }
    }
</script>
